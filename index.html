<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Balls AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0b; --panel:#151515; --accent:#00ffc8; --muted:#9aa0a6;
    --bubble-user:#052b24; --bubble-bot:#111111;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e9f9f3}
  .wrap{max-width:900px;margin:28px auto;padding:18px}
  header{text-align:center;margin-bottom:8px}
  h1{margin:0;color:var(--accent);font-size:28px;display:inline-flex;align-items:center;gap:10px}
  .panel{background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.2));border-radius:14px;padding:18px;box-shadow:0 10px 40px rgba(0,255,200,0.03)}
  #chat-window{height:62vh;overflow:auto;padding:18px;border-radius:12px;background:#131313;border:1px solid rgba(0,255,200,0.04);box-shadow:0 0 40px rgba(0,255,200,0.04) inset}
  .msg{margin:12px 0;display:flex;gap:12px;align-items:flex-start}
  .avatar{width:36px;height:36px;border-radius:9px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700}
  .avatar.user{background:linear-gradient(180deg,#003b2f,#00593f);color:white}
  .avatar.bot{background:transparent;color:var(--accent);border:1px solid rgba(0,255,200,0.08)}
  .bubble{max-width:78%;padding:12px 14px;border-radius:10px;font-size:14px;line-height:1.45}
  .user .bubble{margin-left:auto;background:var(--bubble-user);color:var(--accent);border-radius:12px 12px 6px 12px}
  .bot .bubble{background:var(--bubble-bot);color:#dfeee6;border-radius:12px 12px 12px 6px;border:1px solid rgba(0,255,200,0.02)}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .controls{display:flex;gap:10px;padding-top:12px;align-items:center}
  input[type="text"]{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#0f0f0f;color:#fff;outline:none}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  .attach-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .attach-item{background:#0f0f0f;border-radius:8px;padding:6px 8px;font-size:12px;border:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center}
  .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 8px;border-radius:6px;cursor:pointer}
  .readmore{color:var(--accent);cursor:pointer;font-weight:600;margin-left:8px}
  .message-actions{margin-top:8px;display:flex;gap:8px;align-items:center}
  .tts-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:6px;cursor:pointer;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Balls AI <span style="font-size:16px">ðŸ’¬</span></h1></header>

  <div class="panel">
    <div id="chat-window" aria-live="polite"></div>

    <div style="padding-top:12px">
      <div style="display:flex;gap:10px;align-items:center">
        <input id="textInput" type="text" placeholder="Type a message..." />
        <input id="fileInput" type="file" style="display:none" multiple />
        <button id="attachBtn" class="small-btn">Attach</button>
        <button id="sendBtn">Send</button>
      </div>

      <div class="attach-list" id="attachList"></div>
      <div style="margin-top:8px;font-size:12px;color:var(--muted)">Chats saved locally in your browser. Use TTS to hear replies.</div>
    </div>
  </div>
</div>

<script>
/* Helper: localStorage chat history key */
const STORAGE_KEY = "ballsai_history_v1";

let chatWindow = document.getElementById("chat-window");
let textInput = document.getElementById("textInput");
let sendBtn = document.getElementById("sendBtn");
let attachBtn = document.getElementById("attachBtn");
let fileInput = document.getElementById("fileInput");
let attachList = document.getElementById("attachList");

let attachments = []; // {name,type,data(base64)}

/* Load history from localStorage */
let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
renderHistory();

/* Attach controls */
attachBtn.addEventListener("click", ()=> fileInput.click());
fileInput.addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files).slice(0,4); // limit to 4 attachments
  for (const file of files) {
    const base64 = await fileToBase64(file);
    attachments.push({ name: file.name, type: file.type, data: base64 });
  }
  renderAttachList();
});

/* send */
sendBtn.addEventListener("click", sendMessage);
textInput.addEventListener("keypress", (e)=> { if(e.key==="Enter") sendMessage(); });

async function sendMessage(){
  const text = textInput.value.trim();
  if(!text && attachments.length===0) return;
  // push user message
  const userMsg = { role: "user", text, time: Date.now(), attachments: attachments.map(a=>({name:a.name,type:a.type})) };
  history.push(userMsg);
  saveHistory();
  renderMessage(userMsg);
  textInput.value="";
  renderAttachList(); // clear attachments UI only after sending

  // prepare short history to send (keep last few)
  const historyForModel = history.slice(-8).map(h=>({role:h.role,text:h.text}));

  // call backend
  const res = await fetch("/api/chat", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ message: text, history: historyForModel, attachments: userMsg.attachments })
  });

  let json;
  try { json = await res.json(); } catch(e){ renderError("No response from server"); return; }

  const botMsg = { role:"assistant", text: (json.reply || "No reply."), time:Date.now() };
  history.push(botMsg);
  saveHistory();
  renderMessage(botMsg);
  attachments = []; // clear attachments after send
  renderAttachList();
}

/* Convert file to base64 (for preview & optionally sending) */
function fileToBase64(file) {
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* Render attachments preview */
function renderAttachList(){
  attachList.innerHTML = "";
  attachments.forEach((a, idx) => {
    const el = document.createElement("div");
    el.className = "attach-item";
    el.innerHTML = `${a.name} <button style="margin-left:8px" onclick="removeAttach(${idx})" class="small-btn">Remove</button>`;
    attachList.appendChild(el);
  });
  if(attachments.length===0) attachList.innerHTML = "";
}
window.removeAttach = (i) => { attachments.splice(i,1); renderAttachList(); };

/* Save to localStorage */
function saveHistory(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }

/* Render whole history */
function renderHistory(){
  chatWindow.innerHTML="";
  history.forEach(renderMessage);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* Render single message object */
function renderMessage(msg){
  const wrapper = document.createElement("div");
  wrapper.className = "msg " + (msg.role==="user" ? "user" : "bot");
  const avatar = document.createElement("div");
  avatar.className = "avatar " + (msg.role==="user" ? "user" : "bot");
  avatar.textContent = msg.role==="user" ? "You" : "ðŸ¤–";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  // meta line
  const meta = document.createElement("div");
  meta.className = "meta";
  const time = new Date(msg.time || Date.now()).toLocaleTimeString();
  meta.textContent = `${msg.role==="user" ? "You" : "Balls AI"} â€¢ ${time}`;
  bubble.appendChild(meta);

  // content: possibly long -> show truncated with read more
  const content = document.createElement("div");
  content.className = "content";
  const full = msg.text || "";
  const maxLen = 520;
  if(full.length > maxLen){
    const short = full.slice(0, maxLen) + "...";
    content.innerHTML = `<div class="text">${escapeHtml(short)}</div>`;
    const rm = document.createElement("span");
    rm.className = "readmore";
    rm.textContent = "Read more";
    rm.onclick = ()=> { if(rm.textContent==="Read more"){ content.innerHTML = `<div class='text'>${escapeHtml(full)}</div>`; rm.textContent="Show less"; addActions(); } else { content.innerHTML = `<div class='text'>${escapeHtml(short)}</div>`; rm.textContent="Read more"; addActions(); } };
    content.appendChild(rm);
  } else {
    content.innerHTML = `<div class="text">${escapeHtml(full)}</div>`;
  }
  bubble.appendChild(content);

  // attachments preview (if included in the message)
  if(msg.attachments && msg.attachments.length){
    const att = document.createElement("div");
    att.style.marginTop = "8px";
    att.innerHTML = msg.attachments.map(a => `<div style="font-size:12px;color:${a.type.startsWith("image/") ? "#9fe7c8": "#cfcfcf"}">ðŸ“Ž ${a.name}</div>`).join("");
    bubble.appendChild(att);
  }

  // message actions (TTS play)
  function addActions(){
    const actions = document.createElement("div");
    actions.className = "message-actions";
    if(msg.role==="assistant"){
      const tts = document.createElement("button");
      tts.className="tts-btn";
      tts.textContent = "ðŸ”Š Play";
      tts.onclick = ()=> speak(msg.text || "");
      actions.appendChild(tts);
    }
    bubble.appendChild(actions);
  }
  addActions();

  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);
  chatWindow.appendChild(wrapper);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* TTS using Web Speech API */
function speak(text){
  if(!("speechSynthesis" in window)) return alert("TTS not supported in this browser.");
  const ut = new SpeechSynthesisUtterance();
  ut.text = text;
  ut.rate = 1;
  ut.pitch = 1;
  // choose a voice if available
  const voices = speechSynthesis.getVoices();
  if(voices.length) ut.voice = voices.find(v=> v.lang.startsWith("en")) || voices[0];
  speechSynthesis.cancel();
  speechSynthesis.speak(ut);
}

/* Small helpers */
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"' :"&quot;","'":"&#39;"}[m])); }

function renderError(msg){
  const err = { role:"assistant", text: "Error: " + msg, time: Date.now() };
  history.push(err); saveHistory(); renderMessage(err);
}
</script>
</body>
</html>
